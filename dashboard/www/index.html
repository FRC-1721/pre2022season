<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
</head>

<body style="background-color:rgb(78, 78, 78);">

    <!-- This starts the NetworkTables websocket, it can be accessed from multiple
     pages simultaneously -->
    <script src="/networktables/networktables.js"></script>

    <!-- Obviously, you will want to copy this file locally in a real 
     dashboard, as the Driver Station won't have internet access -->
    <script src="https://code.jquery.com/jquery-2.2.2.min.js"></script>

    <!-- uncomment this is you want to use included utility functions that
     implement common functionality that you might find useful. Requires
     that d3.js and jQuery are included first -->
    <!-- <script src="/networktables/utils.js"></script> -->

    <div>
        NetworkTables websocket: <span id="connectstate">Unknown state</span><br />
        Robot: <span id="robotstate">Unknown state</span> @ <span id="robotAddress">disconnected</span>
    </div>
    <hr />

    <canvas id="SwerveCanvas" width="1000" height="400"></canvas>


    <script type="text/javascript">
        "use strict";

        $(document).ready(function () {

            // sets a function that will be called when the websocket connects/disconnects
            NetworkTables.addWsConnectionListener(onNetworkTablesConnection, true);

            // sets a function that will be called when the robot connects/disconnects
            NetworkTables.addRobotConnectionListener(onRobotConnection, true);

            NetworkTables.addGlobalListener(swerveListener, true);
            console.log("Started")
        });

        function swerveListener(key, value, isNew) {
            //console.log(key)

            var canvas = document.getElementById('SwerveCanvas');
            if (canvas.getContext) {
                var lf = canvas.getContext('2d');
                var swerveDriveImage = new Image();
                swerveDriveImage.src = 'resources/swerveModule.png'

                //console.log(key, value)
                if (key == "/SmartDashboard/SwerveDrive/fp_target") {
                    lf.clearRect(0, 0, 150, 150);
                    //save the untranslated/unrotated context
                    lf.save();
                    lf.beginPath();
                    //move the rotation point to the center of the rect
                    lf.translate(25 + 50 / 2, 25 + 75 / 2);
                    //rotate the rect
                    lf.rotate(value);
                    //draw the rect on the transformed context
                    //Note: after transforming [0,0] is visually [x,y]
                    //so the rect needs to be offset accordingly when drawn
                    lf.drawImage(swerveDriveImage, -50 / 2, -75 / 2);
                    lf.fill();
                    //restore the context to its untranslated/unrotated state
                    lf.restore();
                }

                if (key == "/SmartDashboard/SwerveDrive/fs_target") {
                    lf.clearRect(150, 0, canvas.width, 150);
                    lf.save();
                    lf.beginPath();
                    lf.translate(200 + 50 / 2, 25 + 75 / 2);
                    lf.rotate(value);
                    lf.drawImage(swerveDriveImage, 50, 75);
                    lf.fill();
                    lf.restore();
                }

                if (key == "/SmartDashboard/SwerveDrive/as_target") {
                    lf.clearRect(0, 150, 150, canvas.height);
                    lf.save();
                    lf.beginPath();
                    lf.translate(25 + 50 / 2, 300 + 75 / 2);
                    lf.rotate(value);
                    lf.rect(-50 / 2, -75 / 2, 50, 75);
                    lf.fill();
                    lf.restore();
                }

                if (key == "/SmartDashboard/SwerveDrive/ap_target") {
                    lf.clearRect(150, 150, canvas.width, canvas.height);
                    lf.save();
                    lf.beginPath();
                    lf.translate(200 + 50 / 2, 300 + 75 / 2);
                    lf.rotate(value);
                    lf.rect(-50 / 2, -75 / 2, 50, 75);
                    lf.fill();
                    lf.restore();
                }

            }
        }

        function onRobotConnection(connected) {
            $('#robotstate').text(connected ? "Connected!" : "Disconnected");
            $('#robotAddress').text(connected ? NetworkTables.getRobotAddress() : "disconnected");
        }

        function onNetworkTablesConnection(connected) {

            if (connected) {
                $("#connectstate").text("Connected!");

                // clear the table
                $("#nt tbody > tr").remove();

                console.log(NetworkTables.getKeys())

            } else {
                $("#connectstate").text("Disconnected!");
            }
        }

    </script>

</body>

</html>